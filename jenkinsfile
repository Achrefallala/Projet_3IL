pipeline {
  agent any

  stages {
    stage('Supprimer les dépendances existantes') {
      steps {
        script {
          sh 'rm -rf node_modules'
        }
      }
    }

    stage('Installer les dépendances') {
      steps {
        script {
          sh 'npm install --legacy-peer-deps'
        }
      }
    }

    stage('Installation de Forever') {
      steps {
        script {
          sh 'npm install -g forever'
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        script {
          def scannerHome = tool 'scanner'
          withSonarQubeEnv {
            sh "${scannerHome}/bin/sonar-scanner"
          }
        }
      }
    }

    stage('Démarrer l'application avec Forever') {
      steps {
        script {
          sh 'forever start `which npm` start'
        }
      }
    }

    stage('Construction des images (node et mongo)') {
      steps {
        script {
          sh('docker-compose build')
        }
      }
    }
  }
}
